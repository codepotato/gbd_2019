group_by(Name, Age_group, Week_number, Week_start, Week_range_label) %>%
summarise(Dose_1 = sum(Dose_1, na.rm = TRUE),
Dose_2 = sum(Dose_2, na.rm = TRUE)) %>%
ungroup()
week_x <- ifelse(paste0(date2week(last_date, numeric = TRUE)-1, ifelse(last_date < '2021-01-04', ' - 2020', ' - 2021')) == '0 - 2021', '53 - 2020', paste0(date2week(last_date, numeric = TRUE)-1, ifelse(last_date < '2021-01-04', ' - 2020', ' - 2021')))
date_weeks_x <- week_start_vac %>%
filter(Week_number == week_x)
weeks_to_keep <- week_start_vac %>%
filter(Week_start <= date_weeks_x$Week_start) %>%
arrange(desc(Week_number)) %>%
filter(week_id %in% seq(date_weeks_x$week_id - 2, date_weeks_x$week_id, 1)) %>%
arrange(week_id)
wsx_wk_by_wk_1 <- all_age_vac %>%
filter(Week_number %in% weeks_to_keep$Week_number) %>%
select(Name, Age_group, Week_range_label, Dose_1) %>%
mutate(Week_range_label = paste0('1st doses ', Week_range_label)) %>%
pivot_wider(names_from = Week_range_label,
values_from = Dose_1)
wsx_wk_by_wk_2 <- all_age_vac %>%
filter(Week_number %in% weeks_to_keep$Week_number) %>%
select(Name, Age_group, Week_range_label, Dose_2) %>%
mutate(Week_range_label = paste0('2nd doses ', Week_range_label)) %>%
pivot_wider(names_from = Week_range_label,
values_from = Dose_2)
wsx_wk_by_wk <- wsx_wk_by_wk_1 %>%
left_join(wsx_wk_by_wk_2,  by = c('Name', 'Age_group')) %>%
mutate(Age_group = factor(Age_group, levels = c('12 and over','12-15 years','16-17 years','18-24 years','25-29 years','30-34 years','35-39 years','40-44 years','45-49 years','50-54 years','55-59 years','60+ years'))) %>%
arrange(Name, desc(Age_group))
wsx_wk_by_wk %>%
names() %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/vaccine_wk_by_wk_age_headings.json'))
wsx_wk_by_wk %>%
rename(Age_group = 2) %>%
rename(First_dose_week_minus_3 = 3) %>%
rename(First_dose_week_minus_2 = 4) %>%
rename(First_dose_week_minus_1 = 5) %>%
rename(Second_dose_week_minus_3 = 6) %>%
rename(Second_dose_week_minus_2 = 7) %>%
rename(Second_dose_week_minus_1 = 8) %>%
mutate(Label = paste0(Name, Age_group)) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/vaccine_wk_by_wk_age.json'))
age_denominators_1 <- vaccine_age_df %>%
filter(Date == max(Date)) %>%
select(Name, Age_group, Denominator)
age_denominators_2 <- age_denominators_1 %>%
group_by(Name) %>%
summarise(Denominator = sum(Denominator, na.rm = TRUE)) %>%
mutate(Age_group = '12 and over')
age_denominators <- age_denominators_1 %>%
bind_rows(age_denominators_2)
# cumulative timeseries by age ####
cumulative_vac <- vaccine_ts_df %>%
mutate(Age_group = '12 and over') %>%
bind_rows(vaccine_age_df) %>%
mutate(Age_group = factor(Age_group, levels = c('12 and over', '12-15 years','16-17 years',"18-24 years", "25-29 years", "30-34 years", "35-39 years", "40-44 years", "45-49 years", "50-54 years", "55-59 years", "60-64 years", "65-69 years", "70-74 years", "75-79 years", "80-84 years", "85-89 years", "90+ years"))) %>%
mutate(Date_label = format(Date, '%d %b %y'))
cumulative_vac %>%
filter(Date == max(Date)) %>%
select(Name, Age_group, Denominator) %>%
unique() %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/vaccine_age_denominators.json'))
cumulative_vac %>%
select(Name, Age_group, Date_label, Cumulative_dose_1, Cumulative_dose_2) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/cumulative_vaccine_age_data.json'))
# Week by week percentage
weekly_prop_df <- vaccine_ts_df %>%
mutate(Age_group = '12 and over') %>%
bind_rows(vaccine_age_df) %>%
select(!c(cumVaccinationFirstDoseUptakeByVaccinationDatePercentage,cumVaccinationCompleteCoverageByVaccinationDatePercentage,cumVaccinationSecondDoseUptakeByVaccinationDatePercentage)) %>%
mutate(Week_number = paste0(date2week(Date, numeric = TRUE), ifelse(Date < '2021-01-04', ' - 2020', ' - 2021' ))) %>%
left_join(week_start_vac, by = 'Week_number') %>%
mutate(Week_number = factor(Week_number, levels = c("1 - 2020", "2 - 2020",  "3 - 2020", "4 - 2020",  "5 - 2020",  "6 - 2020",  "7 - 2020",  "8 - 2020",  "9 - 2020",  "10 - 2020", "11 - 2020", "12 - 2020", "13 - 2020", "14 - 2020", "15 - 2020", "16 - 2020", "17 - 2020", "18 - 2020", "19 - 2020", "20 - 2020", "21 - 2020", "22 - 2020", "23 - 2020", "24 - 2020", "25 - 2020", "26 - 2020", "27 - 2020", "28 - 2020", "29 - 2020", "30 - 2020", "31 - 2020", "32 - 2020", "33 - 2020", "34 - 2020", "35 - 2020", "36 - 2020", "37 - 2020", "38 - 2020", "39 - 2020", "40 - 2020", "41 - 2020", "42 - 2020", "43 - 2020", "44 - 2020", "45 - 2020", "46 - 2020", "47 - 2020", "48 - 2020", "49 - 2020", "50 - 2020", "51 - 2020", "52 - 2020", "53 - 2020", "1 - 2021", "2 - 2021", "3 - 2021", "4 - 2021",  "5 - 2021",  "6 - 2021",  "7 - 2021", "8 - 2021",  "9 - 2021",  "10 - 2021", "11 - 2021", "12 - 2021", "13 - 2021", "14 - 2021", "15 - 2021", "16 - 2021", "17 - 2021", "18 - 2021", "19 - 2021", "20 - 2021", "21 - 2021", "22 - 2021", "23 - 2021", "24 - 2021", "25 - 2021", "26 - 2021", "27 - 2021", "28 - 2021", "29 - 2021", "30 - 2021", "31 - 2021", "32 - 2021", "33 - 2021", "34 - 2021", "35 - 2021", "36 - 2021", "37 - 2021", "38 - 2021", "39 - 2021", "40 - 2021", "41 - 2021", "42 - 2021", "43 - 2021", "44 - 2021", "45 - 2021", "46 - 2021", "47 - 2021", "48 - 2021", "49 - 2021", "50 - 2021", "51 - 2021", "52 - 2021"))) %>%
# mutate(Age_group = ifelse(Age_group %in% c('60-64 years','65-69 years','70-74 years','75-79 years','80-84 years','85-89 years','90+ years'), '60+ years', Age_group)) %>%
group_by(Name, Age_group, Week_number, Week_start, Week_range_label) %>%
summarise(Dose_1 = sum(Dose_1, na.rm = TRUE),
Dose_2 = sum(Dose_2, na.rm = TRUE)) %>%
ungroup() %>%
left_join(age_denominators, by = c('Name', 'Age_group')) %>%
mutate(Proportion_dose_1 = Dose_1 / Denominator) %>%
mutate(Proportion_dose_2 = Dose_2 / Denominator)
weekly_prop_1 <- weekly_prop_df %>%
mutate(Week_range_label = paste0('1st doses ', Week_range_label)) %>%
select(Name, Age_group, Week_range_label, Proportion_dose_1) %>%
pivot_wider(names_from = Week_range_label,
values_from = Proportion_dose_1) %>%
mutate(Dose = 'Dose 1')
weekly_prop_2 <- weekly_prop_df %>%
select(Name, Age_group, Week_range_label, Proportion_dose_2) %>%
mutate(Week_range_label = paste0('2nd doses ', Week_range_label)) %>%
pivot_wider(names_from = Week_range_label,
values_from = Proportion_dose_2) %>%
mutate(Dose = 'Dose 2')
wsx_wk_by_wk_prop <- weekly_prop_1 %>%
bind_rows(weekly_prop_2) %>%
mutate(Age_group = factor(Age_group, levels = c('12 and over','16-17 years', "18-24 years", "25-29 years", "30-34 years", "35-39 years", "40-44 years", "45-49 years", "50-54 years", "55-59 years", "60-64 years", "65-69 years", "70-74 years", "75-79 years", "80-84 years", "85-89 years", "90+ years"))) %>%
arrange(Name, desc(Age_group))
wsx_wk_by_wk_prop %>%
write.csv(., paste0(output_directory_x, '/weekly_doses_proportion.csv'), row.names = FALSE)
# recreating vaccine at a glance LTLA ####
latest_denominators_1 <- vaccine_age_df %>%
filter(Date == max(Date)) %>%
select(Name, Age_group, Denominator)
latest_denominators_2 <-  vaccine_age_df %>%
filter(Date == max(Date)) %>%
filter(Age_group %in% c('65-69 years','70-74 years','75-79 years','80-84 years','85-89 years','90+ years')) %>%
select(Name, Denominator) %>%
group_by(Name) %>%
summarise(Denominator = sum(Denominator, na.rm = TRUE)) %>%
mutate(Age_group = '65 and over') %>%
ungroup()
latest_denominators_3 <-  vaccine_age_df %>%
filter(Date == max(Date)) %>%
filter(Age_group %in% c('16-17 years',"18-24 years", "25-29 years", "30-34 years", "35-39 years", "40-44 years", "45-49 years", "50-54 years", "55-59 years",'60-64 years')) %>%
select(Name, Denominator) %>%
group_by(Name) %>%
summarise(Denominator = sum(Denominator, na.rm = TRUE)) %>%
mutate(Age_group = '16-64 years') %>%
ungroup()
latest_denominators <- latest_denominators_1 %>%
group_by(Name) %>%
summarise(Denominator = sum(Denominator, na.rm = TRUE)) %>%
mutate(Age_group = '12 and over') %>%
ungroup() %>%
bind_rows(latest_denominators_1) %>%
bind_rows(latest_denominators_2) %>%
bind_rows(latest_denominators_3)
vaccine_df_ltla_1 <- vaccine_age_df %>%
group_by(Name, Age_group) %>%
summarise(Dose_1 = sum(Dose_1, na.rm = TRUE),
Dose_2 = sum(Dose_2, na.rm = TRUE)) %>%
left_join(latest_denominators, by = c('Name', 'Age_group'))
vaccine_df_ltla_2 <- vaccine_age_df %>%
filter(Age_group %in% c('65-69 years','70-74 years','75-79 years','80-84 years','85-89 years','90+ years')) %>%
group_by(Name) %>%
summarise(Dose_1 = sum(Dose_1, na.rm = TRUE),
Dose_2 = sum(Dose_2, na.rm = TRUE)) %>%
mutate(Age_group = '65 and over') %>%
left_join(latest_denominators, by = c('Name', 'Age_group'))
vaccine_df_ltla_3 <- vaccine_age_df %>%
filter(Age_group %in% c('16-17 years',"18-24 years", "25-29 years", "30-34 years", "35-39 years", "40-44 years", "45-49 years", "50-54 years", "55-59 years",'60-64 years')) %>%
group_by(Name) %>%
summarise(Dose_1 = sum(Dose_1, na.rm = TRUE),
Dose_2 = sum(Dose_2, na.rm = TRUE)) %>%
mutate(Age_group = '16-64 years') %>%
left_join(latest_denominators, by = c('Name', 'Age_group'))
vaccine_df_ltla_4 <- vaccine_age_df %>%
group_by(Name) %>%
summarise(Dose_1 = sum(Dose_1, na.rm = TRUE),
Dose_2 = sum(Dose_2, na.rm = TRUE)) %>%
mutate(Age_group = '12 and over') %>%
left_join(latest_denominators, by = c('Name', 'Age_group'))
vaccine_df_ltla <- vaccine_df_ltla_2 %>%
bind_rows(vaccine_df_ltla_3) %>%
bind_rows(vaccine_df_ltla_4) %>%
mutate(Proportion_dose_1 = Dose_1 / Denominator)
vaccine_df_ltla_pt_1 <- vaccine_df_ltla%>%
select(Name, Dose_1, Age_group) %>%
mutate(Age_group = factor(Age_group, levels = c('12 and over', '16-64 years', '65 and over'))) %>%
arrange(Age_group) %>%
mutate(label = paste0('Number of individuals aged ', Age_group)) %>%
select(!Age_group) %>%
pivot_wider(names_from = label,
values_from = Dose_1)
vaccine_df_ltla_pt_2 <- vaccine_df_ltla%>%
select(Name, Proportion_dose_1, Age_group) %>%
mutate(Age_group = factor(Age_group, levels = c('12 and over', '16-64 years', '65 and over'))) %>%
arrange(Age_group) %>%
mutate(label = paste0('Proportion (', Age_group, ')')) %>%
select(!Age_group) %>%
pivot_wider(names_from = label,
values_from = Proportion_dose_1)
vaccine_df_ltla_pt_1 %>%
left_join(vaccine_df_ltla_pt_2, by = 'Name') %>%
select(Name, `Number of individuals aged 12 and over`, `Proportion (12 and over)`, `Number of individuals aged 16-64 years`, `Proportion (16-64 years)`, `Number of individuals aged 65 and over`, `Proportion (65 and over)`) %>%
mutate(Name = factor(Name, levels = c('Adur' ,'Arun', 'Chichester', 'Crawley', 'Horsham', 'Mid Sussex', 'Worthing', 'West Sussex', 'South East', 'England'))) %>%
arrange(Name) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/vaccine_at_a_glance.json'))
#
# vaccine_df_ltla %>%  toJSON() %>%
#   write_lines(paste0(mobile_output_directory_x, '/vaccine_at_a_glance.json'))
# vaccine_df_ltla_pt_1 %>%
#   left_join(vaccine_df_ltla_pt_2, by = 'Name') %>%
#   select(Name, `Number of individuals aged 18 and over`, `Proportion (18 and over)`, `Number of individuals aged 18-64 years`, `Proportion (18-64 years)`, `Number of individuals aged 65 and over`, `Proportion (65 and over)`) %>%
#   mutate(Name = factor(Name, levels = c('Adur' ,'Arun', 'Chichester', 'Crawley', 'Horsham', 'Mid Sussex', 'Worthing', 'West Sussex', 'South East', 'England'))) %>%
#   arrange(Name) %>%
#   toJSON() %>%
#   write_lines(paste0(mobile_output_directory_x, '/vaccine_at_a_glance.json'))
vaccine_df_ltla %>%
mutate(prop_dose_2 = Dose_2 / Denominator) %>%
filter(Age_group == '12 and over') %>%
view()
vaccine_age_df %>%
filter(Age_group == '16-17 years') %>%
filter(Date == max(Date)) %>%
select(Name, Cumulative_dose_1, Cumulative_dose_2, Denominator) %>%
mutate(prop_dose_1 = Cumulative_dose_1 / Denominator) %>%
mutate(prop_dose_2 = Cumulative_dose_2 / Denominator) %>%
view()
population_df <- unique(list.files("~/gbd_data/Population")) %>%
map_df(~read_csv(paste0("~/gbd_data/Population/",.)))
View(population_df)
names(population_df)
population_df <- unique(list.files("~/gbd_data/Population")) %>%
map_df(~read_csv(paste0("~/gbd_data/Population/",.))) %>%
select(location_name, sex_name, age_group_name, year_id, val, upper, lower) %>%
filter(location_name == 'West Sussex')
View(population_df)
unique(population_df$age_group_name)
population_df <- unique(list.files("~/gbd_data/Population")) %>%
map_df(~read_csv(paste0("~/gbd_data/Population/",.))) %>%
select(location_name, sex_name, age_group_name, year_id, val, upper, lower) %>%
filter(location_name == 'West Sussex') %>%
filter(age_group_name %in% c('Early Neonatal', 'Late Neonatal', 'Post Neonatal', '1 to 4', '5 to 9', "10 to 14","15 to 19","20 to 24", "25 to 29","30 to 34","35 to 39","40 to 44", "45 to 49", "50 to 54", "55 to 59", "60 to 64", "65 to 69", "70 to 74", "75 to 79", "80 plus",'All Ages'))
All_age_pop <- population_df %>%
filter(age_group_name = 'All Ages')
All_age_pop <- population_df %>%
filter(age_group_name == 'All Ages')
View(All_age_pop)
All_age_pop <- population_df %>%
filter(age_group_name == 'All Ages') %>%
pivot_wider(names_from = 'sex_name',
values_from = 'val')
All_age_pop <- population_df %>%
filter(age_group_name == 'All Ages') %>%
select(sex_name, age_group_name, year_id, val) %>%
pivot_wider(names_from = 'sex_name',
values_from = 'val')
View(All_age_pop)
All_age_pop <- population_df %>%
filter(age_group_name == 'All Ages') %>%
select(location_name, sex_name, age_group_name, year_id, val) %>%
pivot_wider(names_from = 'sex_name',
values_from = 'val')
View(All_age_pop)
All_age_pop %>%
toJSON() %>%
view()
All_age_pop %>%
view()
All_age_pop %>%
toJSON() %>%
write_lines(paste0(output_directory, '/wsx_population.json'))
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.)))
View(comparison_df)
comparison_label_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(!age)
View(comparison_label_df)
comparison_label_df_1 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val) %>%
pivot_wider(names_from = 'metric',
values_from = 'val')
View(comparison_label_df_1)
comparison_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val, lower, upper)
comparison_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val, lower, upper) %>%
filter(metric == 'Rate')
View(comparison_label_df_2)
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val, lower, upper) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(round(val, 1), ' (', round(lower, 1), '-', round(upper, 1), ')'))
View(comparison_rate_label_df_2)
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(round(val, 1), ' (', round(lower, 1), '-', round(upper, 1), ')')) %>%
select(measure, location, sex, cause, metric, year, rate_label)
View(comparison_label_df_1)
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(round(val, 1), ' (', ifelse(lower == 0, 0, ifelse(round(lower, 1) == 0.0, '<0.01', round(upper, 1))), '-', ifelse(upper == 0, 0, ifelse(round(upper, 1) == 0.0, '<0.01', round(upper, 1))), ')')) %>%
select(measure, location, sex, cause, metric, year, rate_label)
View(comparison_rate_label_df_2)
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(ifelse(val == 0, 0, ifelse(round(val, 1) == 0.0, '<0.01', round(val, 1))), ' (', ifelse(lower == 0, 0, ifelse(round(lower, 1) == 0.0, '<0.01', round(upper, 1))), '-', ifelse(upper == 0, 0, ifelse(round(upper, 1) == 0.0, '<0.01', round(upper, 1))), ')')) %>%
select(measure, location, sex, cause, metric, year, rate_label)
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', round(val, 1)))), ' (', ifelse(lower == 0, 0, ifelse(lower < 0.01, '<0.01', ifelse(lower < 0.05, '<0.05', round(lower, 1)))), '-', ifelse(upper == 0, 0, ifelse(upper < 0.01, '<0.01', ifelse(upper < 0.05, '<0.05', round(upper, 1)))), ')')) %>%
select(measure, location, sex, cause, metric, year, rate_label)
View(comparison_rate_label_df_2)
comparison_label_df_1 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val) %>%
mutate(val = paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', round(val, 1)))))) %>%
pivot_wider(names_from = 'metric',
values_from = 'val')
View(comparison_label_df_1)
comparison_label_df_1 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val) %>%
mutate(val = ifelse(metric == 'Percent', paste0(round(val * 100, 1), '%'), paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', round(val, 1))))))) %>%
pivot_wider(names_from = 'metric',
values_from = 'val')
View(comparison_label_df_1)
comparison_label_df_1 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val) %>%
mutate(val = ifelse(metric == 'Percent', paste0(ifelse(val * 100 < 0.1, '<0.1', round(val * 100, 1)), '%'), paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', round(val, 1))))))) %>%
pivot_wider(names_from = 'metric',
values_from = 'val')
comparison_label_df_1 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val) %>%
mutate(val = ifelse(metric == 'Percent', paste0(ifelse(val * 100 < 0.01, '<0.01', ifelse(val * 100 < 0.1, '<0.1', round(val * 100, 1))), '%'), paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', round(val, 1))))))) %>%
pivot_wider(names_from = 'metric',
values_from = 'val')
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', round(val, 1)))), ' (', ifelse(lower == 0, 0, ifelse(lower < 0.01, '<0.01', ifelse(lower < 0.05, '<0.05', round(lower, 1)))), '-', ifelse(upper == 0, 0, ifelse(upper < 0.01, '<0.01', ifelse(upper < 0.05, '<0.05', round(upper, 1)))), ')')) %>%
select(measure, location, sex, cause, metric, year, rate_label)
comparison_label <- comparison_label_df_1 %>%
left_join(comparison_rate_label_df_2, by = c('measure', 'location', 'sex', 'cause', 'year'))
View(comparison_label)
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', round(val, 1)))), ' (', ifelse(lower == 0, 0, ifelse(lower < 0.01, '<0.01', ifelse(lower < 0.05, '<0.05', round(lower, 1)))), '-', ifelse(upper == 0, 0, ifelse(upper < 0.01, '<0.01', ifelse(upper < 0.05, '<0.05', round(upper, 1)))), ')')) %>%
select(measure, location, sex, cause, year, rate_label)
comparison_label <- comparison_label_df_1 %>%
left_join(comparison_rate_label_df_2, by = c('measure', 'location', 'sex', 'cause', 'year'))
comparison_label_df <- comparison_label_df_1 %>%
left_join(comparison_rate_label_df_2, by = c('measure', 'location', 'sex', 'cause', 'year'))
View(comparison_label_df)
comparison_label_df_1 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val) %>%
mutate(val = ifelse(metric == 'Percent', paste0(ifelse(val * 100 < 0.01, '<0.01', ifelse(val * 100 < 0.1, '<0.1', round(val * 100, 1))), '%'), paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', format(round(val, 1), big.mark = ','))))))) %>%
pivot_wider(names_from = 'metric',
values_from = 'val')
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', format(round(val, 1), big.mark = ',')))), ' (', ifelse(lower == 0, 0, ifelse(lower < 0.01, '<0.01', ifelse(lower < 0.05, '<0.05', format(round(lower, 1), big.mark = ',')))), '-', ifelse(upper == 0, 0, ifelse(upper < 0.01, '<0.01', ifelse(upper < 0.05, '<0.05', format(round(upper, 1), big.mark = ',')))), ')')) %>%
select(measure, location, sex, cause, year, rate_label)
comparison_label_df <- comparison_label_df_1 %>%
left_join(comparison_rate_label_df_2, by = c('measure', 'location', 'sex', 'cause', 'year'))
View(comparison_label_df)
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', format(round(val, 1), big.mark = ',', trim = TRUE)))), ' (', ifelse(lower == 0, 0, ifelse(lower < 0.01, '<0.01', ifelse(lower < 0.05, '<0.05', format(round(lower, 1), big.mark = ',', trim = TRUE)))), '-', ifelse(upper == 0, 0, ifelse(upper < 0.01, '<0.01', ifelse(upper < 0.05, '<0.05', format(round(upper, 1), big.mark = ',', trim = TRUE)))), ')')) %>%
select(measure, location, sex, cause, year, rate_label)
comparison_label_df <- comparison_label_df_1 %>%
left_join(comparison_rate_label_df_2, by = c('measure', 'location', 'sex', 'cause', 'year'))
comparison_label_df_1 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val) %>%
mutate(val = ifelse(metric == 'Percent', paste0(ifelse(val * 100 < 0.01, '<0.01', ifelse(val * 100 < 0.1, '<0.1', round(val * 100, 1))), '%'), paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', format(round(val, 1), big.mark = ',', trim = TRUE))))))) %>%
pivot_wider(names_from = 'metric',
values_from = 'val')
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', format(round(val, 1), big.mark = ',', trim = TRUE)))), ' (', ifelse(lower == 0, 0, ifelse(lower < 0.01, '<0.01', ifelse(lower < 0.05, '<0.05', format(round(lower, 1), big.mark = ',', trim = TRUE)))), '-', ifelse(upper == 0, 0, ifelse(upper < 0.01, '<0.01', ifelse(upper < 0.05, '<0.05', format(round(upper, 1), big.mark = ',', trim = TRUE)))), ')')) %>%
select(measure, location, sex, cause, year, rate_label)
comparison_label_df <- comparison_label_df_1 %>%
left_join(comparison_rate_label_df_2, by = c('measure', 'location', 'sex', 'cause', 'year'))
View(comparison_label_df)
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate')
View(comparison_df)
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds')
View(comparison_df)
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(measure, location, sex, cause, Bound, sep = '_'))
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(measure, location, sex, cause, Bounds, sep = '_'))
View(comparison_df)
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(measure, sex, cause, Bounds, sep = '_'))
View(comparison_df)
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(location, Bounds, sep = '_'))
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(location, Bounds, sep = '_')) %>%
pivot_wider(names_from = 'Bounds',
values_from = 'value')
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(location, Bounds, sep = '_')) %>%
select(!val) %>%
pivot_wider(names_from = 'Bounds',
values_from = 'value')
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(location, Bounds, sep = '_')) %>%
select(!c(val, location)) %>%
pivot_wider(names_from = 'Bounds',
values_from = 'value')
comparison_label_df_1 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
select(measure, location, sex, cause, metric, year, val) %>%
mutate(val = ifelse(metric == 'Percent', paste0(ifelse(val * 100 < 0.01, '<0.01', ifelse(val * 100 < 0.1, '<0.1', round(val * 100, 1))), '%'), paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', format(round(val, 1), big.mark = ',', trim = TRUE))))))) %>%
pivot_wider(names_from = 'metric',
values_from = 'val')
comparison_rate_label_df_2 <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
mutate(rate_label = paste0(ifelse(val == 0, 0, ifelse(val < 0.01, '<0.01', ifelse(val < 0.05, '<0.05', format(round(val, 1), big.mark = ',', trim = TRUE)))), ' (', ifelse(lower == 0, 0, ifelse(lower < 0.01, '<0.01', ifelse(lower < 0.05, '<0.05', format(round(lower, 1), big.mark = ',', trim = TRUE)))), '-', ifelse(upper == 0, 0, ifelse(upper < 0.01, '<0.01', ifelse(upper < 0.05, '<0.05', format(round(upper, 1), big.mark = ',', trim = TRUE)))), ')')) %>%
select(measure, location, sex, cause, year, rate_label)
comparison_label_df <- comparison_label_df_1 %>%
left_join(comparison_rate_label_df_2, by = c('measure', 'location', 'sex', 'cause', 'year'))
View(comparison_label_df)
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(location, Bounds, sep = '_')) %>%
select(!c(val, location)) %>%
pivot_wider(names_from = 'Bounds',
values_from = 'value')
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(gsub(' ', '_', location), Bounds, sep = '_')) %>%
select(!c(val, location)) %>%
pivot_wider(names_from = 'Bounds',
values_from = 'value') %>%
mutate()
comparison_df <- unique(list.files("~/gbd_data")[grepl("Comparison", list.files("~/gbd_data")) == TRUE]) %>%
map_df(~read_csv(paste0("~/gbd_data/",.))) %>%
filter(metric == 'Rate') %>%
pivot_longer(cols = c('lower', 'upper'),
names_to = 'Bounds') %>%
mutate(Bounds = paste(gsub(' ', '_', location), Bounds, sep = '_')) %>%
select(!c(val, location)) %>%
pivot_wider(names_from = 'Bounds',
values_from = 'value') %>%
mutate(West_Sussex_SE_significance = ifelse(West_Sussex_lower > South_East_England_upper, 'Significantly higher', ifelse(West_Sussex_upper < South_East_England_lower, 'Significantly lower', 'Similar'))) %>%
mutate(West_Sussex_Eng_significance = ifelse(West_Sussex_lower > England_upper, 'Significantly higher', ifelse(West_Sussex_upper < England_lower, 'Significantly lower', 'Similar')))
View(comparison_label)
final_comparison_df <- comparison_df %>%
filter(location == 'West Sussex')
final_comparison_df <- comparison_df %>%
filter(Location == 'West Sussex')
final_comparison_df <- comparison_label %>%
filter(Kocation == 'West Sussex')
final_comparison_df <- comparison_label %>%
filter(Location == 'West Sussex')
final_comparison_df <- comparison_label %>%
filter(location == 'West Sussex')
final_comparison_df <- comparison_label_df %>%
filter(location == 'West Sussex')
View(final_comparison_df)
names(comparison_df)
final_comparison_df <- comparison_label_df %>%
filter(location == 'West Sussex') %>%
left_join(comparison_df[c('measure', 'sex', 'cause', 'year', 'West_Sussex_SE_significance', 'West_Sussex_Eng_significance')], by = c('measure', 'sex', 'cause', 'year'))
final_comparison_df <- comparison_label_df %>%
filter(location == 'West Sussex') %>%
left_join(comparison_df[c('measure', 'sex', 'cause', 'year', 'West_Sussex_SE_significance', 'West_Sussex_Eng_significance')], by = c('measure', 'sex', 'cause', 'year')) %>%
mutate(Age = 'All ages') %>%
rename(Sex = sex,
Cause = cause,
Year = year,
Area = location,
Measure = measure)
final_comparison_df %>%
toJSON() %>%
write_lines(paste0(output_directory, '/wsx_compare_df.json'))
